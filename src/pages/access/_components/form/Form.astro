---
import ToastAlert from "@components/ToastAlert.astro";
import "./style.css";
import { getFullUrl } from "src/consts.ts";

interface Props {
  action: "register" | "login";
  method: "post" | "get";
  title: string;
  description: string;
}

const { action, method, title, description } = Astro.props;
---

<div class="auth-container">
  <form {...{ action, method }} data-base={getFullUrl(`/auth/${action}`)}>
    <a href="/" aria-label="regresar al home de la página" class="go-to-home">
      <img
        src="/images/sofilogo.png"
        alt="logo-sofidev"
        width="100"
        height="100"
      />
    </a>
    <h2>{title}</h2>
    <p>{description}</p>
    <section>
      <slot />
      <button type="submit" class="submit-form">
        <iconify-icon
          icon={`si:${action === "login" ? "unlock" : "lock"}-fill`}
          width="20"
          height="20"
        >
        </iconify-icon>
        {action === "login" ? "Iniciar sesión" : "Registrarse"}
      </button>
    </section>
  </form>
  <ToastAlert />
  <span class="divider">
    <p>o</p>
  </span>
  <section class="others-options">
    <a href={`/access/${action === "login" ? "register" : "login"}`}>
      {action === "login" ? "¡Crear mi cuenta!" : "¡Ya tengo una cuenta!"}
    </a>
    <form class="providers" method="post" action={getFullUrl(`/auth/login`)}>
      <button type="submit" name="provider" value="github">
        <iconify-icon icon="bi:github" width="20" height="20"></iconify-icon>
        GitHub
      </button>
      <button type="submit" name="provider" value="google">
        <iconify-icon icon="flat-color-icons:google" width="20" height="20"></iconify-icon>
        Google
      </button>
    </form>
  </section>
</div>

<script>
  import { isAppError } from "src/errors/appError";
  import { registerError } from "src/errors/registerError.ts";
  import ToastNotification from "src/utils/toastAlerts.controller";
  import { TooManyAttemptsError } from "../../_errors/tooManyAttempts.ts";
  import { ERROR_MESSAGES } from "../../_consts";

  const authContainer = document.querySelector(
    ".auth-container"
  ) as HTMLElement;

  const form = authContainer.querySelector("form") as HTMLFormElement;
  const action: string = form.getAttribute("action") || "";
  const method: string = (form.getAttribute("method") || "post").toLowerCase();
  const urlPetition: string = form.dataset.base || "";

  async function renderPetition(body?: FormData) {
    try {
      const fetchOptions: RequestInit = { method };
      if (method === "post" && body) {
        fetchOptions.body = body;
      }
      const res = await fetch(urlPetition, { ...fetchOptions, credentials: "include" });

      if(!res.ok) registerError(res.status);

      const data = await res.json();
      return data;
    } catch (error: any | unknown) {  
      isAppError(error) && ToastNotification(error.message, "error");
      return null;
    }
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const formData: FormData = new FormData(form);
    const response = await renderPetition(formData);

    if(!response) return;
    form.reset();

    if(action.includes("login")) history.go(0); 

    ToastNotification(
      "Cuenta creada con éxito, por favor revisa tu correo para verificarla.",
      "success"
    );
  });

</script>
