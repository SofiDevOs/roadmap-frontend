---
import { getFullUrl } from "src/consts";
import Layout from "../_Layout.astro";
const apiUrl = getFullUrl("/file/upload/image");
---

<Layout
  title="Certificados - Dashboard"
  description="Gestiona tus certificados desde el dashboard"
>
  <h1 class="title-primary">Certificados</h1>
  <section class="template">
    <p>Sube una platilla para los certificados</p>
    <form
      id="file-upload-form"
      enctype="multipart/form-data"
      action={apiUrl}
    >
      <label id="drop-zone" for="file-input">
        Drop images here, or click to upload.
        <input type="file" id="file-input" multiple accept="image/*" />
      </label>
    </form>
    <ul id="preview"></ul>
    <button class="clear-btn" id="clear-btn">Clear</button>
  </section>
</Layout>

<script>
import ToastNotification from "@utils/toastAlerts.controller";
const dropZone = document.getElementById("drop-zone") as HTMLElement;
const fileUploadForm = document.getElementById("file-upload-form") as HTMLFormElement;
const previewContainer = document.getElementById("preview") as HTMLUListElement;

  function delay(ms:number) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  previewContainer.addEventListener("click", async (e) => {
    const target = e.target as HTMLElement;
    if (target.tagName.toLowerCase() !== "button") return;
  
    const icon = target.querySelector("iconify-icon");
    icon?.setAttribute("icon", "line-md:loading-loop");
    
    try {
      const li = target.closest("li");
      if (!li) return;
    
      const img = li.querySelector("img");
      if (!img) return;

      const fileName = img.alt;
      const file = inMemoryFiles.find((f) => f.name === fileName);
    
      if (!file) {
        ToastNotification("File not found in memory", "error");
        return;
      }
    
      await delay(500); 
      await uploadFile(file);
    
      icon?.setAttribute("icon", "qlementine-icons:success-12");
      icon?.setAttribute("style", "color: lightgreen;");
    
      ToastNotification("File uploaded successfully", "success");
      (target as HTMLButtonElement).disabled = true;
    } catch (error) {
      icon?.setAttribute("icon", "ic:twotone-error");
      icon?.setAttribute("style", "color: tomato;");
    
      ToastNotification("Error uploading file", "error");
    } 
});

  const inMemoryFiles: File[] = [];

  dropZone.addEventListener("drop", dropHandler);
  window.addEventListener("drop", (e) => {
    if ([...(e.dataTransfer?.items || [])].some((item) => item.kind === "file")) {
      e.preventDefault();
    }
  });

  dropZone.addEventListener("dragover", (e) => {
    const fileItems = [...(e.dataTransfer?.items || []) ].filter(
      (item) => item.kind === "file"
    );
  
    if (fileItems.length < 0 || !e.dataTransfer) return;
    e.preventDefault();
  
    fileItems.some((item) => item.type.startsWith("image/")) 
      ? e.dataTransfer.dropEffect = "copy"
      : e.dataTransfer.dropEffect = "none";
  });

  window.addEventListener("dragover", (e) => {
    const fileItems = [...(e.dataTransfer?.items || [])].filter(
      (item) => item.kind === "file"
    );
    if (fileItems.length < 0 || !e.dataTransfer) return;
    e.preventDefault();
  
    if (dropZone.contains(e.target as Node)) return;
    e.dataTransfer.dropEffect = "none";

  });
  const preview = document.getElementById("preview") as HTMLUListElement;

  function displayImages(files: FileList | File[]) {
    for (const file of files) {
      if (!file.type.startsWith("image/")) continue;
    
      const li = document.createElement("li"),
        content = document.createElement("div"),
        img = document.createElement("img"),
        button = document.createElement("button"),
        icon = document.createElement("iconify-icon");

      icon.setAttribute("icon", "ic:round-upload");
      icon.setAttribute("width", "26");
      icon.setAttribute("height", "26");
      button.appendChild(icon);

      img.src = URL.createObjectURL(file);
      img.alt = file.name;
      content.appendChild(img);
      content.appendChild(button);
      li.appendChild(content);
      preview.appendChild(li);
    }
  }

  function appendFileToFormData(file: File) {
    const formData = new FormData(fileUploadForm);
    formData.append("file", file);
    formData.append("filename", `certificados/${file.name}`);
    return formData;
  }

  async function uploadFile(file : File) {
    const formData = appendFileToFormData(file);
    const res = await fetch(fileUploadForm.action, {
        method: "POST",
        body: formData,
        credentials: "include",
    });
    if(!res.ok) throw new Error("File upload failed");
  }

  async function dropHandler(ev: DragEvent) {
    ev.preventDefault();
    const files = [...(ev.dataTransfer?.items || [])]
      .map((item) => item.getAsFile())
      .filter((file) => file) as File[] | FileList;
    
    displayImages(files);
    for (const file of files) {
      inMemoryFiles.push(file);
    }
  }

  const fileInput = document.getElementById("file-input") as HTMLInputElement;
  
  fileInput.addEventListener("change", async (e) => {
    const target = e.target as HTMLInputElement;
    if (!target.files) return;
  
    displayImages(target.files);
  
    for (const file of target.files) {
      inMemoryFiles.push(file);
    }
  });

  const clearBtn = document.getElementById("clear-btn") as HTMLButtonElement;
  clearBtn.addEventListener("click", () => {
    for (const img of preview.querySelectorAll("img")) {
      URL.revokeObjectURL(img.src);
    }
    preview.textContent = "";
  });
</script>

<style is:inline>
  .template {
    display: flex;
    flex-direction: column;
    gap: 1em;
    align-items: flex-start;
  }

  #drop-zone {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 500px;
    max-width: 100%;
    height: 200px;
    padding: 1em;
    border: 1px solid var(--secondary-color);
    border-radius: 6px;
    color: slategray;
    cursor: pointer;
  }

  #file-input {
    display: none;
  }

  #preview {
    width: 100%;
    max-width: 100%;
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 0.5em;
    list-style: none;
    padding: 0;
  }

  #preview li {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5em;
    margin: 0;
    color: white;
    font-size: 1.4rem;
    justify-content: flex-start;
    div {
      width: 100%;
      overflow: hidden;
      height: 100%;
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: space-evenly;
      background: #1c2737;
      border-radius: 12px;
      border: 1px solid #fff0;
      button {
        background: transparent;
        color: white;
        border: none;
        cursor: pointer;
        padding: 1rem;
        &:disabled {
          cursor: not-allowed;
          opacity: 0.6;
        }
      }
    }
  }

  #preview img {
    max-height: 6rem;
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .clear-btn {
    padding: 0.5em 1em;
    font-size: 1.7rem;
    background-color: var(--secondary-color);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
</style>
