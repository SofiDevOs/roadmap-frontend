---
import LessonsForm from "./_components/LessonsForm.astro";
import Layout from "../_Layout.astro";
import ToastAlert from "@components/ToastAlert.astro";

const user_id = Astro.locals.user.id;
---

<Layout buttonContent="Ver cursos" buttonUrl="/dashboard/lecciones">
  <section class="create-roadmap">
    <h2 class="title-secundary action-title">Crear nueva leccion</h2>
    <LessonsForm formId="create-lesson" {user_id} />
    <ToastAlert />
  </section>
</Layout>
<script>
  import { actions } from 'astro:actions'
  import toastNotificacion from '@utils/toastAlerts.controller'
  
  const lessonForm = document.getElementById("create-lesson");

  lessonForm?.addEventListener("submit", async (e) => {
    e.preventDefault();
    const formdata = new FormData(e.target as HTMLFormElement);
    const dataObject = Object.fromEntries(formdata.entries());
    
    // @ts-ignore
    const textAreaContent = tinymce?.get("lesson_content").getContent();
    
    const { data } = await actions.api({
      resource: "lessons", 
      data: {...dataObject, content: textAreaContent}
    })

    if(!data) return 
  
    toastNotificacion("Leccion creada con exito", "success");

  });
</script>

<style>
  .create-roadmap {
    display: flex;
    flex-direction: column;
    gap: 3rem;
    width: 100%;
    max-width: 80vw;
  }
</style>
